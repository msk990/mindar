<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Papageno WebAR</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <!-- MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }

      #startButton {
        position: absolute;
        z-index: 10;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
        font-size: 16px;
      }
    </style>
  </head>

  <body>
    <!-- User gesture for audio -->
    <button id="startButton">Start experience</button>

    <a-scene
      mindar-image="imageTargetSrc: ./targets/poster.mind;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <!-- Camera -->
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- IMAGE ANCHOR -->
<a-entity id="posterAnchor" mindar-image-target="targetIndex: 0">

  <a-entity
    id="papageno"
    gltf-model="./froggie.glb"
    position="0 -0.15 0.05"
    scale="0.4 0.4 0.4"
    rotation="0 180 0"
    visible="false"
  ></a-entity>

</a-entity>

    </a-scene>

    <script>
      /*********************************************************
       * AUDIO = MASTER CLOCK
       *********************************************************/
      const audio = new Audio("./papageno.mp3");
      audio.loop = false;

      /*********************************************************
       * STATE
       *********************************************************/
      let audioStarted = false;
      let targetVisible = false;
      let showStarted = false;

      const papageno = document.querySelector("#papageno");
      const anchor = document.querySelector("#posterAnchor");
      const startButton = document.getElementById("startButton");

      /*********************************************************
       * TIMELINE (seconds from music start)
       *********************************************************/
      const TIMELINE = {
        papagenoEnter: 0.5,
        papagenoSing: 2.0,
        end: 34.0
      };

      /*********************************************************
       * USER CLICK → UNLOCK AUDIO
       *********************************************************/
  let musicStartTime = null;

startButton.onclick = async () => {
  await audio.play();
  musicStartTime = audio.currentTime;
  audioStarted = true;

  startButton.style.display = "none";
  tryStartShow();
};



      /*********************************************************
       * IMAGE TARGET EVENTS
       *********************************************************/
anchor.addEventListener("targetFound", () => {
  targetVisible = true;
  tryStartShow();
});


anchor.addEventListener("targetLost", () => {
  console.log("❌ TARGET LOST");
  targetVisible = false;
});

      /*********************************************************
       * START SHOW WHEN READY
       *********************************************************/
      function maybeStartShow() {
        if (audioStarted && targetVisible && !showStarted) {
          showStarted = true;
          startTimeline();
        }
      }


      function tryStartShow() {
  if (
    audioStarted &&
    targetVisible &&
    !showStarted &&
    musicStartTime !== null
  ) {
    showStarted = true;
    startTimeline();
  }
}

      /*********************************************************
       * TIMELINE LOOP (audio-driven)
       *********************************************************/
      function startTimeline() {
  const t0 = musicStartTime;

  let appeared = false;
  let swayStarted = false;

  function tick() {
    const t = audio.currentTime - t0;

    // Guard: if music stopped, abort visuals
    if (audio.paused) return;

    // Papageno appears AFTER music
    if (t > 2.0 && !appeared) {
      appeared = true;
      papageno.setAttribute("visible", true);

      papageno.setAttribute("animation__rise", {
        property: "position",
        from: "0 -0.15 0.05",
        to: "0 0.02 0.05",
        dur: 2000,
        easing: "easeOutCubic"
      });

      papageno.setAttribute("animation__scale", {
        property: "scale",
        from: "0.05 0.05 0.05",
        to: "0.12 0.12 0.12",
        dur: 2000,
        easing: "easeOutBack"
      });
    }

    // Sway starts WITH music
    if (t > 2.0 && appeared && !swayStarted) {
      swayStarted = true;

      papageno.setAttribute("animation__sway", {
        property: "rotation",
        from: "0 175 0",
        to: "0 185 0",
        dir: "alternate",
        dur: 900,
        loop: true,
        easing: "easeInOutSine"
      });
    }

    requestAnimationFrame(tick);
  }

  requestAnimationFrame(tick);
}

    </script>
  </body>
</html>
